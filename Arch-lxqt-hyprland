#!/bin/bash

# Check for root privileges
if [[ $EUID -ne 0 ]]; then
   echo "This script must be run as root."
   exit 1
fi

# Update package list and upgrade system
echo "Updating package list and upgrading system..."
pacman -Syu --noconfirm

# Install necessary packages
echo "Installing Wayland, LXQt, Hyprland, SDDM, Kitty, PipeWire, PulseAudio, xdg-desktop-portal, curl, and ImageMagick..."
pacman -S --noconfirm wayland wayland-protocols lxqt hyprland sddm kitty pipewire pipewire-alsa pipewire-pulse \
xdg-desktop-portal xdg-desktop-portal-hyprland pulseaudio pavucontrol curl imagemagick ttf-dancing-script

# Enable SDDM as the default display manager
echo "Enabling SDDM as the default display manager..."
systemctl enable sddm.service

# Create a custom theme directory for SDDM
SDDM_THEME_DIR="/usr/share/sddm/themes/stickman-theme"
mkdir -p "$SDDM_THEME_DIR"

# Set up SDDM theme configuration
echo "Setting up SDDM theme..."
cat <<EOL > "$SDDM_THEME_DIR/theme.conf"
[General]
background=/usr/share/sddm/themes/stickman-theme/background.jpg
type=QML

[Greeter]
position=center
EOL

# Create the QML layout for SDDM theme
echo "Creating QML layout file..."
cat <<EOL > "$SDDM_THEME_DIR/Main.qml"
import QtQuick 2.0
import QtQuick.Controls 2.0
import org.kde.plasma.core 2.0 as PlasmaCore

Item {
    id: root

    Rectangle {
        id: backgroundRect
        anchors.fill: parent
        gradient: Gradient {
            GradientStop { position: 0.0; color: "yellow" }
            GradientStop { position: 1.0; color: "purple" }
        }
    }

    // Login form on the left
    Column {
        anchors.centerIn: parent
        spacing: 20

        PlasmaCore.Label {
            text: "Username:"
            font.pixelSize: 24
            color: "white"
        }

        TextField {
            id: usernameField
            width: 300
            font.pixelSize: 24
        }

        PlasmaCore.Label {
            text: "Password:"
            font.pixelSize: 24
            color: "white"
        }

        TextField {
            id: passwordField
            width: 300
            echoMode: TextInput.Password
            font.pixelSize: 24
        }

        Button {
            text: "Login"
            onClicked: {
                // Trigger the login function
                login()
            }
        }
    }

    // "Stickman-OS" text centered
    Text {
        id: stickmanText
        text: "Stickman-OS"
        anchors.centerIn: parent
        font.pixelSize: 72
        font.family: "Dancing Script"
        color: "mediumgrey"
    }
}
EOL

# Generate a background image for SDDM
echo "Generating background image..."
convert -size 1920x1080 gradient:yellow-purple -font Dancing-Script -pointsize 120 \
    -gravity center -fill mediumgrey -annotate +0+0 'Stickman-OS' "$SDDM_THEME_DIR/background.jpg"

# Set SDDM to use the new theme
echo "Configuring SDDM to use the new theme..."
mkdir -p /etc/sddm.conf.d/
cat <<EOL > /etc/sddm.conf.d/theme.conf
[Theme]
Current=stickman-theme
EOL

# Create the desktop background with a gradient and centered text
echo "Generating desktop background with gradient and centered text..."
BACKGROUND_IMG="/usr/share/lxqt/themes/stickman-background/default-background.png"
mkdir -p "/usr/share/lxqt/themes/stickman-background"
convert -size 1920x1080 gradient:yellow-purple -font Dancing-Script -pointsize 120 \
    -gravity center -fill mediumgrey -annotate +0+0 'Stickman-OS' "$BACKGROUND_IMG"

# Set LXQt default desktop background
LXQT_BACKGROUND_DIR="/usr/share/lxqt/themes/stickman-background"
mkdir -p "$LXQT_BACKGROUND_DIR"

echo "Configuring LXQt to use the new background..."
mkdir -p ~/.config/pcmanfm-qt/lxqt/
cat <<EOL > ~/.config/pcmanfm-qt/lxqt/settings.conf
[Desktop]
wallpaper=/usr/share/lxqt/themes/stickman-background/default-background.png
EOL

# Enable necessary services in systemd
echo "Enabling necessary services (SDDM, PipeWire, and PulseAudio)..."
systemctl enable sddm.service
systemctl enable --user pipewire.service
systemctl enable --user pipewire-pulse.service

echo "Installation and setup complete. Reboot your system to apply changes."
